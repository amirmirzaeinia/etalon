#!/bin/sh

####  This program collects some information about a system running a myri driver
####  Non trivial bug reports should include the output file generated by this program
####   to ease/speed-up problem resolution diagnotic

export MYRI_DIR=/opt/snf/sbin
export MYRI_DRIVER=myri_snf
PATH=$MYRI_DIR:$MYRI_DIR/../bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH

if test "$MYRI_DRIVER" == "myri_mx" -a -z "${FMS_RUN}"; then
  FMS_RUN=
fi

error ()
{
 echo >&2
 echo "ERROR:$@" >&2
 exit 1
}

delim ()
{
 set +x
 echo ""
 echo "***************"
 echo "***************"
 echo "** $@"
 echo "***************"
}

delimx ()
{
 set +x
 delim "$@"
 set -x
}

output="myri_bug.`hostname --short`-`date +%F_%H%m%S`.txt"
test "`id -nu`" = root || echo "**WARNING: not root user: report will be incomplete:please run as root**" >&2
echo "Will collect system info in file:" >&2
echo "     $output.gz  " >&2
echo " " >&2
echo "     Starting collecting system information..." >&2

(
exec > "$output" || error "cannot create $output file"
exec 2>&1
exec < /dev/null

###########################################
#Start collection various system information
###########################################

set -x
id -a
uname -a
set +x

for f in /etc/debian_version /etc/cat /etc/redhat-release /etc/SuSE-release; do
 if test -r $f ; then 
  delim $f
  cat "$f"
 fi
done

for f in /proc/cpuinfo /proc/meminfo /proc/version /proc/uptime  \
          /proc/cmdline /proc/interrupts /proc/net/dev /proc/iomem \
          /proc/mtrr; do
 delim "$f:"
 cat $f
done

delim "dmesg output"
dmesg

for logfile in /var/log/messages.1 /var/log/messages.0 /var/log/messages ; do
 if test -r $logfile  ; then
    delim "$logfile extract"
    egrep -A3 -B3 -i "mx|gm|lanai" "$logfile" | tail -n 2000
 fi
done

delim "lspci -vv -xxx"
lspci  -vv -xxx
delim "lspci -vv -xxx -d 14c1:"
lspci -vv -xxx -d 14c1:

find /sys/module/ -maxdepth 1 -type d | awk '/\/sys\/module\/(mx|myri)_/ { print $1 }' |
while read module; do
  if test -d $module/parameters; then
    delim $module params
    find $module/parameters -type f | xargs head
  fi
done

delim "/dev/myri* info"
ls -l /dev/myri*
head /dev/myri*

delim "myri_info"
myri_info 2>&1

delim "myri_endpoint_info"
myri_endpoint_info

delimx "myri_counters -q -b 0"
myri_counters -q -b 0

delim myri_dmabench
myri_dmabench

bnum=0`myri_endpoint_info 2> /dev/null | head -1 | cut -d" " -f1`
bmax=`expr "$bnum" - 1`

for b in `seq 1 $bmax` ; do
   delim "myri_counters -q -b $b"
   myri_counters -q -b $b
   delim "myri_dmabench -b $b"
   myri_dmabench -b $b
done
set +x

delimx "myri_info"

export UBA_PCI=proc

myri_info -vv
rawnum=`myri_info 2> /dev/null | grep pci-dev | wc -l`
rawnum=`expr "$rawnum" - 1`

for b in `seq 0 $rawnum` ; do
   delim "myri_lmesg -s -b $b"
   myri_lmesg -s -b $b
done


for b in `seq 0 $rawnum` ; do
   delim "myri_mdio_rw -b $b"
   myri_mdio_rw -b $b
done

for b in `seq 0 $rawnum` ; do
   delim "myri_ze_scan -b $b"
   myri_ze_scan -b $b
done
set +x

find /sys/class/net/ -maxdepth 1 |
while read d; do
  v="$d/device/vendor";
  test -e $v && grep -q 0x14c1 $v || continue
  ifdev=`echo $(basename $d)`;
  delim "ethtool -a $ifdev"
  ethtool -a $ifdev
  delim "ethtool -S $ifdev"
  ethtool -S $ifdev
  delim "ethtool -c $ifdev"
  ethtool -c $ifdev
done

delim "process info"
ps -ef

if test -n "$FMS_RUN"; then
  delimx "mapper files"
  ls -l /var/run/mx_mapper/*
  tail -n 100 /var/run/mx_mapper/err.* /var/run/mx_mapper/verbose.* 2>&1

  cat /var/run/mx_mapper/map*.0

  for b in `seq 1 $bmax` ; do
     delim "mx_mapper/map.$b"
     cat /var/run/mx_mapper/map*.$b
  done
  set +x

  delimx "fma/fms files"
  ls -l $FMS_RUN/.
  tail -n 1000 $FMS_RUN/fm*log 2>&1

  if test "$FMS_RUN" != /var/run/fms ; then
    ls -l /var/run/fms/.
    tail -n 1000 /var/run/fms/fm*log 2>&1
  fi
fi
set +x

delim "lsmod"
lsmod

if test -f /proc/config.gz ; then
  delim /proc/config.gz
  zcat /proc/config.gz
else
  delim "/boot/config-`uname -r`"
  cat /boot/config-`uname -r`
fi

for f in /var/log/dmesg /var/log/boot.msg; do
 if test -r $f ; then 
  delim $f
  cat "$f"
 fi
done

delim "ifconfig -a"
ifconfig -a

delim "/proc/net/dev"
cat /proc/net/dev

delim "dmidecode"
dmidecode


delim "sysctl info"
sysctl -a

delim "END OF BUG REPORT"

exit 0
) || error "collection failed"

### end of collection, compress file #####
echo >&2
rm -f "$output.gz"
gzip -9 "$output" || error "Cannot compress $output!?"
echo "" >&2
echo "    $output.gz created" >&2
echo "    Please send it to help@myri.com with a description of your problem" >&2
echo "" >&2
